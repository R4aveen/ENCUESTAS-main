{% extends "base.html" %}
{% load auth_extras %}

{% block title %}Panel Territorial - Incidencias{% endblock %}

{% block content %}
<div class="container">
  <style>
    .action-col {
      display: grid;
      gap: 6px;
      align-content: start;
    }
    .btn-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 11px;
      border-radius: 10px;
      border: 1px solid #d7d7d7;
      background: #fff;
      color: #1f2937;
      font-weight: 700;
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.2s ease;
      text-decoration: none;
    }
    .btn-chip:hover { transform: translateY(-1px); box-shadow: 0 14px 24px rgba(0,0,0,0.12); }
    .btn-chip.primary { background: #0ea5e9; color: #fff; border-color: #0ea5e9; }
    .btn-chip.warn { background: #f97316; color: #fff; border-color: #f97316; }
    .btn-chip.danger { background: #ef4444; color: #fff; border-color: #ef4444; }
    .btn-chip.success { background: #22c55e; color: #fff; border-color: #22c55e; }
    .btn-chip.neutral { background: #f1f5f9; color: #0f172a; border-color: #e2e8f0; }
    .btn-chip small { font-weight: 600; opacity: 0.9; }
    .inc-table {
      font-size: 0.95rem;
    }
    .inc-table th, .inc-table td {
      padding: 10px 12px;
      line-height: 1.2;
      vertical-align: middle;
    }
    .inc-table tbody tr:nth-child(even) { background: #fafcff; }
    details.dropdown {
      position: relative;
      display: inline-block;
    }
    details.dropdown summary {
      list-style: none;
      cursor: pointer;
      padding-right: 12px;
      min-width: 120px;
      justify-content: center;
    }
    details.dropdown[open] .dropdown-menu {
      display: grid;
    }
    details.dropdown summary::-webkit-details-marker { display: none; }
    .dropdown-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.12);
      padding: 8px;
      min-width: 180px;
      display: none;
      z-index: 5;
      gap: 6px;
    }
    .dropdown-menu a { width: 100%; justify-content: flex-start; }
    .action-col { position: relative; }
    @media (max-width: 768px) {
      .action-col { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
    }
  </style>

  <h1>Panel Territorial</h1>
  <p>Bienvenido. Aqu√≠ puedes monitorear el trabajo en terreno y coordinar con jefes de cuadrilla.</p>

  <hr>
  <h3>Gesti√≥n de Incidencias</h3>

  <!-- Filtros y busqueda -->
  <form method="get" class="mb-3 d-flex gap-2 align-items-center">
    <input type="text" name="q" placeholder="Buscar por t√≠tulo" value="{{ q }}" class="form-control" style="max-width:320px;">

    <select name="estado" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los estados --</option>
      <option value="pendiente"   {% if estado_seleccionado == 'pendiente' %}selected{% endif %}>Pendiente</option>
      <option value="en_proceso"  {% if estado_seleccionado == 'en_proceso' %}selected{% endif %}>En proceso</option>
      <option value="finalizada"  {% if estado_seleccionado == 'finalizada' %}selected{% endif %}>Finalizada</option>
      <option value="validada"    {% if estado_seleccionado == 'validada' %}selected{% endif %}>Validada</option>
      <option value="rechazada"   {% if estado_seleccionado == 'rechazada' %}selected{% endif %}>Rechazada</option>
    </select>

    <!-- Filtro por departamento -->
    <select name="departamento" class="form-select" style="max-width:220px;" onchange="this.form.submit()">
      <option value="">-- Todos los departamentos --</option>
      {% for depto in departamentos %}
        <option value="{{ depto.id }}" {% if departamento_seleccionado == depto.id|stringformat:"s" %}selected{% endif %}>
          {{ depto.nombre_departamento }}
        </option>
      {% endfor %}
    </select>

    <button type="submit" class="btn btn-primary">Buscar</button>
    <a href="{% url 'incidencias:incidencia_crear' %}" class="btn btn-success ms-2">‚ûï Nueva Incidencia</a>
  </form>

  <p class="text-muted" style="margin-top:-6px;">
    Mostrando {{ incidencias|length }} incidencia{% if incidencias|length != 1 %}s{% endif %}
    {% if q %} con b√∫squeda "<strong>{{ q }}</strong>"{% endif %}
    {% if estado_seleccionado %} y estado <strong>{{ estado_seleccionado }}</strong>{% endif %}
    {% if departamento_seleccionado %} en el departamento <strong>{{ departamento_nombre }}</strong>{% endif %}.
  </p>

  <!-- Tabla de incidencias -->
  <table class="table table-striped align-middle mt-3 inc-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>T√≠tulo</th>
        <th>Estado</th>
        <th>Prioridad</th>
        <th>Departamento</th>
        <th>Cuadrilla</th>
        <th>Fecha de cierre</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for incidencia in incidencias %}
        <tr>
          <td>{{ incidencia.id }}</td>
          <td>{{ incidencia.titulo }}</td>
          <td>
            {% if incidencia.estado == 'pendiente' %}
              <span class="badge bg-secondary">Pendiente</span>
            {% elif incidencia.estado == 'en_proceso' %}
              <span class="badge bg-warning text-dark">En proceso</span>
            {% elif incidencia.estado == 'finalizada' %}
              <span class="badge bg-success">Finalizada</span>
            {% elif incidencia.estado == 'validada' %}
              <span class="badge bg-info">Validada</span>
            {% elif incidencia.estado == 'rechazada' %}
              <span class="badge bg-danger">Rechazada</span>
            {% else %}
              {{ incidencia.estado }}
            {% endif %}
          </td>
          <td>{{ incidencia.prioridad }}</td>
          <td>{{ incidencia.departamento.nombre_departamento }}</td>
          <td>
            {% if incidencia.cuadrilla %}
              {{ incidencia.cuadrilla.nombre_cuadrilla }}
            {% else %}
              Sin asignar
            {% endif %}
          </td>
          <td>
            {% if incidencia.fecha_cierre %}
              {{ incidencia.fecha_cierre|date:"d/m/Y H:i" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="action-col">
            <details class="dropdown">
              <summary class="btn-chip neutral" style="justify-content:space-between; min-width: 140px;">‚ãØ Acciones</summary>
              <div class="dropdown-menu">
                <a href="{% url 'incidencias:incidencia_detalle' incidencia.id %}" class="btn-chip neutral">üëÅÔ∏è Ver</a>
                
                <!-- EDITAR: Permitir tambi√©n en 'rechazada' para corregir -->
                {% if incidencia.estado == 'pendiente' or incidencia.estado == 'en_proceso' or incidencia.estado == 'rechazada' %}
                  {% if user.is_superuser or user|has_group:"Administrador" or user|has_group:"Jefe de Cuadrilla" or user|has_group:"Cuadrilla" or user|has_group:"Territorial" %}
                    <a href="{% url 'incidencias:incidencia_editar' incidencia.id %}?next={% url 'incidencias:incidencias_lista' %}" class="btn-chip primary">‚úèÔ∏è Editar</a>
                  {% endif %}
                {% endif %}

                <!-- SUBIR EVIDENCIA / FINALIZAR (Cuadrilla) -->
                {% if incidencia.estado == 'en_proceso' and incidencia.cuadrilla %}
                  {% if user.is_superuser or user|has_group:"Administrador" or user|has_group:"Jefe de Cuadrilla" or user|has_group:"Cuadrilla" or user|has_group:"Territorial" %}
                    <a href="{% url 'incidencias:subir_evidencia' incidencia.id %}" class="btn-chip warn">üì§ Subir evidencia</a>
                  {% endif %}
                  {% if incidencia.multimedias.exists %}
                    {% if user.is_superuser or user|has_group:"Administrador" or user|has_group:"Jefe de Cuadrilla" or user|has_group:"Cuadrilla" or user|has_group:"Territorial" %}
                      <a href="{% url 'incidencias:finalizar_incidencia' incidencia.id %}" class="btn-chip success" onclick="return confirm('¬øFinalizar esta incidencia?')">‚úÖ Finalizar</a>
                    {% endif %}
                  {% endif %}
                {% endif %}

                <!-- VALIDAR / RECHAZAR / REASIGNAR (Territorial) -->
                {% if user|has_group:"Territorial" or user.is_superuser or user|has_group:"Administrador" %}
                  <!-- Validar/Rechazar solo cuando est√° FINALIZADA por la cuadrilla -->
                  {% if incidencia.estado == 'finalizada' %}
                    <a href="{% url 'territorial_app:validar_incidencia' incidencia.id %}" class="btn-chip success">‚úÖ Validar</a>
                    <a href="{% url 'territorial_app:rechazar_incidencia' incidencia.id %}" class="btn-chip danger">‚ùå Rechazar</a>
                  {% endif %}
                  
                  <!-- Reasignar si est√° pendiente/en proceso -->
                  {% if incidencia.estado == 'pendiente' or incidencia.estado == 'en_proceso' %}
                     <a href="{% url 'territorial_app:reasignar_incidencia' incidencia.id %}" class="btn-chip warn">üîÑ Reasignar</a>
                  {% endif %}
                {% endif %}

                {% if user.is_superuser or user|has_group:"Administrador" or user|has_group:"Territorial" %}
                  <a href="{% url 'incidencias:incidencia_eliminar' incidencia.id %}" class="btn-chip danger">üóëÔ∏è Eliminar</a>
                {% endif %}
              </div>
            </details>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8">No hay incidencias asignadas.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
