{% extends "base.html" %}
{% load auth_extras %}

{% block content %}
<h2>Detalle de Incidencia #{{ obj.id }}</h2>
<table border="1" cellpadding="8" cellspacing="0" width="100%">
  <tr>
    <td valign="top" width="50%">
      <table border="0" cellpadding="6" cellspacing="0" width="100%">
        <tr>
          <td><b>T√≠tulo:</b></td>
          <td>{{ obj.titulo }}</td>
        </tr>
        <tr>
          <td><b>Descripci√≥n:</b></td>
          <td>{{ obj.descripcion }}</td>
        </tr>
        <tr>
          <td><b>Estado:</b></td>
          <td>{{ obj.estado|capfirst }}</td>
        </tr>
        <tr>
          <td><b>Prioridad:</b></td>
          <td>{{ obj.prioridad }}</td>
        </tr>
        <tr>
          <td><b>Departamento:</b></td>
          <td>{{ obj.departamento }}</td>
        </tr>
        <tr>
          <td><b>Cuadrilla:</b></td>
          <td>{% if obj.cuadrilla %}{{ obj.cuadrilla }}{% else %}Sin asignar{% endif %}</td>
        </tr>
        <tr>
          <td><b>Fecha de cierre:</b></td>
          <td>{% if obj.fecha_cierre %}{{ obj.fecha_cierre|date:"d/m/Y H:i" }}{% else %}-{% endif %}</td>
        </tr>
        <tr>
          <td><b>Vecino:</b></td>
          <td>{{ obj.nombre_vecino }} ({{ obj.correo_vecino }}, {{ obj.telefono_vecino }})</td>
        </tr>
        {% if obj.motivo_rechazo %}
        <tr>
          <td><b>Motivo de rechazo:</b></td>
          <td>{{ obj.motivo_rechazo }}</td>
        </tr>
        {% endif %}
      </table>
    </td>
    <td valign="top" width="50%">
      {% if obj.multimedias.exists %}
      {% for multimedia in obj.multimedias.all %}
      <table border="1" cellpadding="6" cellspacing="0" width="100%">
        <tr>
          <th colspan="2">{{ multimedia.nombre }}</th>
        </tr>
        <tr>
          <td valign="top" width="220">
            <b>Tipo:</b> {{ multimedia.tipo|upper }}<br>
            <b>Formato:</b> {{ multimedia.formato|upper }}<br>
            <b>Subido:</b> {{ multimedia.creadoEl|date:"d/m/Y H:i" }}<br>
          </td>
          <td align="center">
            {% if multimedia.tipo == 'image' %}
            <img src="{{ multimedia.url }}" alt="{{ multimedia.nombre }}" width="220"><br>
            <a href="{{ multimedia.url }}" target="_blank">Ver imagen grande</a>
            {% elif multimedia.tipo == 'video' %}
            <video width="220" controls>
              <source src="{{ multimedia.url }}" type="video/{{ multimedia.formato }}">
              Tu navegador no soporta el video.
            </video><br>
            <a href="{{ multimedia.url }}" target="_blank">Ver video grande</a>
            {% elif multimedia.tipo == 'application' and multimedia.formato|lower == 'pdf' %}
            <a href="{{ multimedia.url }}" target="_blank">Ver PDF</a>
            {% else %}
            <a href="{{ multimedia.url }}" target="_blank">Descargar archivo</a>
            {% endif %}
          </td>
        </tr>
      </table>
      <hr>
      {% endfor %}
      {% endif %}
    </td>
  </tr>
</table>
<hr>

<!-- Botones de acci√≥n -->
  <div class="mt-3 d-flex gap-2">
    {% if user.is_superuser or user|has_group:"Administrador" %}
      <a href="{% url 'incidencias:incidencia_editar' obj.pk %}" class="btn btn-warning">‚úèÔ∏è Editar</a>
      <a href="{% url 'incidencias:incidencia_eliminar' obj.pk %}" class="btn btn-danger">üóëÔ∏è Eliminar</a>
    {% endif %}

    {# Subir evidencia / finalizar para cuadrillas y territorio #}
    {% if obj.estado == 'en_proceso' and obj.cuadrilla %}
      {% if user.is_superuser or user|has_group:"Administrador" or user|has_group:"Jefe de Cuadrilla" or user|has_group:"Cuadrilla" %}
        <a href="{% url 'incidencias:subir_evidencia' obj.pk %}" class="btn btn-success">
          üì§ Subir evidencia
        </a>
        {% if obj.multimedias.exists %}
          <a href="{% url 'incidencias:finalizar_incidencia' obj.pk %}" class="btn btn-primary"
            onclick="return confirm('¬øEst√°s seguro de finalizar esta incidencia? El territorial podr√° validar o rechazar tu trabajo.')">
            ‚úÖ Finalizar incidencia
          </a>
        {% endif %}
      {% endif %}
    {% endif %}

  {% if user.is_superuser or user|has_group:"Administrador" %}
  <a href="{% url 'incidencias:incidencias_lista' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver a la lista</a>
  {% elif user|has_group:"Territorial" %}
  <a href="{% url 'personas:dashboard_territorial' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver al Dashboard</a>
  {% elif user|has_group:"Departamento" %}
  <a href="{% url 'personas:dashboard_departamento' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver al Dashboard</a>
  {% elif user|has_group:"Jefe de Cuadrilla" %}
  <a href="{% url 'personas:dashboard_jefeCuadrilla' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver al Dashboard</a>
  {% elif user|has_group:"Direcci√≥n" %}
  <a href="{% url 'personas:dashboard_direccion' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver al Dashboard</a>
  {% else %}
  <a href="{% url 'personas:check_profile' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver</a>
  {% endif %}
</div>
{% endblock %}
